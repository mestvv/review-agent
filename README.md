# Review Agent

RAG-система для анализа научных статей с генерацией обзоров литературы.

## Установка

```bash
pip install -r requirements.txt
```

## Настройка

Создайте `.env` файл (см. `.env.example`):

```
# LLM для базового агента (ask, review команды)
LLM_MODEL=deepseek/deepseek-r1-0528-qwen3-8b
LLM_BASE_URL=http://localhost:1234/v1
LLM_API_KEY=lm-studio
LLM_TEMPERATURE=0.1

# LLM для агента с инструментами (agent, chat команды)
# ВАЖНО: deepseek-reasoner несовместим с LangGraph, используйте deepseek-chat
AGENT_LLM_MODEL=deepseek-chat

# Опциональные настройки
USE_RERANKER=true
RERANKER_MODEL=jinaai/jina-reranker-v2-base-multilingual
```

## Работа с множественными базами данных

Система поддерживает создание нескольких независимых баз данных. Для этого создайте поддиректории в папке `articles/` и поместите в них файлы:

```
articles/
├── climate/           # БД для климатических статей
│   ├── paper1.pdf
│   ├── notes.md
│   ├── report.docx
│   └── paper2.pdf
├── biology/           # БД для биологических статей
│   ├── paper3.pdf
│   └── summary.md
└── physics/           # БД для физических статей
    ├── paper5.pdf
    └── lecture.docx
```

Каждая поддиректория будет индексирована в отдельную базу данных ChromaDB.

### Поддерживаемые форматы

- **PDF** - научные статьи, книги, документы
- **Markdown (MD)** - заметки, конспекты, собственные документы
- **DOCX** - документы Microsoft Word с поддержкой таблиц и формул (через Docling)

### Обработка таблиц и формул

Система автоматически:
- Распознаёт таблицы в документах и сохраняет их целиком в отдельных чанках
- Сохраняет контекст таблицы (заголовок перед таблицей) для лучшего понимания
- Корректно парсит формулы в LaTeX формате (для DOCX через Docling)
- Выводит предупреждение, если таблица превышает стандартный размер чанка (сохраняя при этом целостность данных)

## Веб-интерфейс

Для запуска веб-интерфейса используйте Streamlit:

```bash
streamlit run app.py
```

Веб-интерфейс будет доступен по адресу `http://localhost:8501`

### Возможности веб-интерфейса

- **Задать вопрос** - ответ на научный вопрос с цитированием источников
- **Обзор литературы** - генерация обзора литературы по теме
- **Поиск чанков** - поиск релевантных фрагментов документов
- **Чат с агентом** - интерактивный диалог с RAG-агентом, который сам ищет информацию
- **Управление БД** - индексация, удаление и просмотр статистики баз данных

## Использование (CLI)

### Просмотр доступных баз данных

```bash
python main.py list-dbs
```

### Индексация

```bash
# Индексация всех баз данных (все поддиректории в articles/)
python main.py index

# Индексация конкретной БД
python main.py index --db climate
```

### Работа с запросами

При выполнении запросов можно указать БД через опцию `--db` или выбрать интерактивно:

```bash
# Ответ на вопрос (с выбором БД)
python main.py ask -q "Ваш вопрос"

# Ответ на вопрос из конкретной БД
python main.py ask -q "Ваш вопрос" --db climate

# Обзор литературы
python main.py review -t "Тема обзора" --db biology

# Поиск чанков (без LLM)
python main.py search -q "запрос" --db physics

# Работа с агентом с инструментами (автоматический поиск информации)
python main.py agent -q "Ваш вопрос" --db climate

# Интерактивный чат с агентом
python main.py chat --db climate
```

### Статистика и управление

```bash
# Статистика всех баз данных
python main.py stats

# Статистика конкретной БД
python main.py stats --db climate

# Очистка БД (интерактивный выбор)
python main.py clear

# Очистка конкретной БД
python main.py clear --db climate
```

## Архитектура системы

Система поддерживает два режима работы:

### 1. Базовый режим (прямой поиск + LLM)
- Команды: `ask`, `review`, `search`
- Прямой поиск чанков с последующей генерацией ответа через LLM
- Подходит для простых запросов с известной БД

### 2. Агент с инструментами (ReAct паттерн)
- Команды: `agent`, `chat`
- Использует LangGraph и ReAct паттерн для автоматического поиска информации
- Агент сам определяет, какие инструменты использовать и может делать несколько запросов
- Инструменты:
  - `list_available_databases` - список доступных БД
  - `search_vector_db` - поиск в векторной БД с реранкингом
  - `search_by_section` - поиск в конкретных секциях статей

Агент автоматически:
- Выбирает подходящую БД (если не указана)
- Формулирует поисковые запросы
- Делает несколько запросов для полного ответа
- Расширяет контекст соседними чанками
- Оценивает уверенность в ответе

## Структура проекта

```
├── main.py              # CLI точка входа
├── app.py               # Streamlit веб-интерфейс
├── src/
│   ├── config.py        # Конфигурация
│   ├── rag/             # RAG модуль
│   │   ├── indexer.py   # Индексация PDF/MD/DOCX с обработкой таблиц
│   │   └── retriever.py # Поиск чанков с реранкингом
│   └── agent/           # Agent модуль
│       ├── prompts.py   # Промпты LLM
│       ├── agent.py     # Базовый агент (прямой поиск + LLM)
│       ├── agent_with_tools.py  # Агент с инструментами (LangGraph)
│       └── tools.py     # Инструменты для агента
├── articles/            # PDF, MD и DOCX файлы для индексации
│   ├── climate/         # Поддиректория для климатических статей
│   │   ├── paper1.pdf
│   │   ├── notes.md
│   │   └── report.docx
│   ├── biology/         # Поддиректория для биологических статей
│   └── physics/         # Поддиректория для физических статей
└── chroma_db/           # Векторные базы данных
    ├── climate/         # БД для climate
    ├── biology/         # БД для biology
    └── physics/         # БД для physics
```

## Примеры использования

### Создание новой базы данных

1. Создайте новую директорию в `articles/`:
   ```bash
   mkdir articles/my_topic
   ```

2. Поместите PDF, MD или DOCX файлы в эту директорию:
   ```bash
   cp *.pdf articles/my_topic/
   cp *.md articles/my_topic/
   cp *.docx articles/my_topic/
   ```

3. Индексируйте базу данных:
   ```bash
   python main.py index --db my_topic
   ```

4. Используйте новую БД для запросов:
   ```bash
   python main.py ask -q "Ваш вопрос" --db my_topic
   ```

### Работа с Markdown файлами

Markdown файлы полезны для:
- Собственных заметок и конспектов
- Перевода статей
- Структурированных документов
- Быстрого добавления информации без PDF

Файлы автоматически разбиваются на чанки с определением секций (введение, методы, результаты и т.д.)

### Работа с DOCX файлами

DOCX файлы обрабатываются через Docling, что обеспечивает:
- Корректный парсинг сложных таблиц
- Извлечение формул в LaTeX формате
- Сохранение структуры документа
- Конвертацию в Markdown для единообразной обработки

Таблицы сохраняются целиком в отдельных чанках с контекстом (заголовком), что обеспечивает целостность табличных данных при поиске.

### Работа с несколькими базами данных

```bash
# Просмотр всех баз
python main.py list-dbs

# Статистика по всем базам
python main.py stats

# Удаление конкретной базы
python main.py clear --db old_topic
```

### Работа с агентом с инструментами

Агент с инструментами использует ReAct паттерн (Reasoning + Acting) для автоматического поиска информации:

```bash
# Одноразовый запрос к агенту
python main.py agent -q "С какой скоростью происходит глобальное потепление?"

# Интерактивный чат с агентом (сохраняет историю диалога)
python main.py chat --db climate

# С указанием температуры генерации
python main.py agent -q "Ваш вопрос" --db climate -t 0.3
```

**Особенности агента:**
- Автоматически определяет, какую БД использовать
- Может делать несколько поисковых запросов для полного ответа
- Расширяет контекст соседними чанками
- Оценивает уверенность в ответе
- Сохраняет логи всех вызовов инструментов в `chunks_log/`

**Команды в чате:**
- `exit` / `quit` / `выход` - выход из чата
- `clear` / `очистить` - очистить историю диалога

**Логирование:**
- Логи агента сохраняются в `chunks_log/{timestamp}_agent/` (один файл на каждый вызов инструмента)
- Сессии чата сохраняются в `responses_log/chat_session_{timestamp}.json` и `results/chat_session_{timestamp}.md`
- Все ответы агента сохраняются в `responses_log/agent_{timestamp}_{query}.json`
